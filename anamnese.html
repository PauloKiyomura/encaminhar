<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="flor.ico" type="image/x-icon" />
    <title>Anamnese Psicopedagógica</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000000 0%, #00193b 100%);
            color: #fff;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(12px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        h1,
        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.7);
            color: #000;
            outline: none;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            margin-bottom: 10px;
        }
        .checkbox-group label {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 30px;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            background-color: #2980b9;
            transform: scale(1.02);
        }

        .expand-title {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expand-title:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .expand-title::after {
            content: '+';
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .expand-title.active::after {
            transform: rotate(45deg);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ANAMNESE PSICOPEDAGÓGICA</h1>

        <form id="anamneseForm">
            <div class="form-section">
              <h2>1. IDENTIFICAÇÃO</h2>
              <div class="form-group"><label>Nome da Criança:</label><input type="text" id="nome" required></div>
              <div class="form-group">
                <div class="form-group"><label>Data de Nascimento:</label><input type="date" id="nascimento" required></div>
                <div class="form-group"><label>Idade:</label><input type="number" id="idade_crianca" readonly></div>
                <div class="form-group"><label>Endereço:</label><input type="text" id="endereco" required></div>
                <div class="form-group"><label>Bairro:</label><input type="text" id="bairro" required></div>
                <div class="form-group"><label>Instituição de Ensino:</label><input type="text" id="escola" required></div>
              </div>
            </div>

            <div class="form-section">
                <h2>2. DADOS DOS RESPONSÁVEIS</h2>
                <div class="form-group"><label>Responsável 1:</label><input type="text" id="resp1" required></div>
                <div class="form-group"><label>Idade:</label><input type="number" id="idade1" required></div>
                <div class="form-group"><label>Escolaridade:</label><input type="text" id="escolaridade1" required></div>
                <div class="form-group"><label>Profissão:</label><input type="text" id="profissao1" required></div>
                <div class="form-group"><label>Responsável 2:</label><input type="text" id="resp2"></div>
                <div class="form-group"><label>Idade:</label><input type="number" id="idade2"></div>
                <div class="form-group"><label>Escolaridade:</label><input type="text" id="escolaridade2"></div>
                <div class="form-group"><label>Profissão:</label><input type="text" id="profissao2"></div>
                <div class="form-group"><label>Genitora:</label><input type="text" id="genitora"></div>
                <div class="form-group"><label>Histórico de outras gestações:</label><input type="text" id="gestacoes"></div>
                <div class="form-group"><label>Partos:</label><input type="number" id="partos"></div>
                <div class="form-group"><label>Abortos:</label><input type="number" id="abortos"></div>
            </div>

            <div class="form-section">
                <h2>3. GESTAÇÃO/NASCIMENTO</h2>
                <div class="form-group"><label>a) A gravidez foi planejada pelos pais?</label><input type="text" id="planeja_pais"></div>
                <div class="form-group"><label>b) A gestação foi uma experiência agradável para a mãe?</label><input type="text" id="gestacao_agreavel"></div>
                <div class="form-group"><label>Por que?</label><input type="text" id="gestacao_por_que"></div>
                <div class="form-group"><label>c) Como foi a saúde da mãe?</label><input type="text" id="saude_mae"></div>
                <div class="form-group"><label>d) E o estado emocional?</label><input type="text" id="estado_emocional"></div>
                <div class="form-group"><label>e) Fez o pré-natal?</label><input type="text" id="fez_prenatal" required></div>
                <div class="form-group"><label>Foi necessário algum tratamento?</label><input type="text" id="tratamento_prenatal"></div>
                <div class="form-group"><label>f) Nascimento - Tipo de parto:</label><input type="text" id="tipo_parto"></div>
            </div>

            <div class="form-section">
                <h2>4. ALIMENTAÇÃO</h2>
                <div class="form-group checkbox-group"><label>a) Foi amamentado?</label><label><input type="radio" name="amamentado" value="sim"> Sim</label><label><input type="radio" name="amamentado" value="nao"> Não</label></div>
                <div class="form-group"><label>b) Teve problemas com alimentação?</label><input type="text" id="problemas"></div>
                <div class="form-group"><label>c) Alimentação atual:</label><input type="text" id="alimentacao"></div>
            </div>

            <div class="form-section">
                <h2>5. SAÚDE</h2>
                <div class="form-group checkbox-group"><label>a) Está com a vacinação atualizada?</label><label><input type="radio" name="vacina" value="sim"> Sim</label><label><input type="radio" name="vacina" value="nao"> Não</label></div>
                <div class="form-group"><label>b) Quais doenças teve na infância?</label><input type="text" id="doencas_infancia"></div>
                <div class="form-group"><label>c) Outras:</label>
                    <div class="checkbox-group"><label><input type="checkbox" name="outras" value="Febre Alta"> Febre Alta</label><label><input type="checkbox" name="outras" value="Convulsoes"> Convulsões</label><label><input type="checkbox" name="outras" value="Cirurgias"> Cirurgias</label><label><input type="checkbox" name="outras" value="Acidentes"> Acidentes</label><label><input type="checkbox" name="outras" value="Alergias"> Alergias</label></div>
                    <div class="checkbox-group"><label><input type="checkbox" name="outras" value="Audição"> Problemas com a audição</label><label><input type="checkbox" name="outras" value="Visao"> Problemas de visão</label></div>
                    <div class="checkbox-group"><label><input type="checkbox" name="outras" value="Faz tratamento"> Faz algum tratamento?</label><input type="text" id="qual_tratamento" placeholder="Qual?"></div>
                    <div class="checkbox-group"><label><input type="checkbox" name="outras" value="Medicamentos"> Faz uso contínuo de medicamentos?</label><input type="text" id="qual_medicamento" placeholder="Qual?"></div>
                </div>
            </div>

            </form>
        <button type="button" onclick="gerarEEnviarPDF()">Salvar e Enviar Anamnese</button>
    </div>

    <script>
        /**
         * Função principal: Gera o PDF com os dados do formulário e o envia para o servidor.
         */
        async function gerarEEnviarPDF() {
            // Pega o nome da criança para usar como nome do arquivo
            const nomeCrianca = document.getElementById('nome')?.value.trim();
            if (!nomeCrianca) {
                alert("Por favor, preencha o nome da criança antes de salvar.");
                return;
            }

            // Cria um nome de arquivo seguro e único (Ex: Joao_Silva_20250812.pdf)
            const dataFormatada = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const nomeArquivo = `${nomeCrianca.replace(/[^a-zA-Z0-9]/g, '_')}_${dataFormatada}.pdf`;

            // Inicializa a biblioteca jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            // Funções auxiliares para preencher o PDF
            let y = 20; // Posição vertical inicial no PDF
            const margin = 20;
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = doc.internal.pageSize.getWidth() - 2 * margin;

            const linha = (texto, espacamento = 7) => {
                if (y > pageHeight - margin) { // Se chegar no fim da página, cria uma nova
                    doc.addPage();
                    y = margin;
                }
                const linhas = doc.splitTextToSize(texto, usableWidth);
                doc.text(linhas, margin, y);
                y += (linhas.length * (espacamento - 2)); // Ajusta o espaçamento para multilinhas
            };
            const get = (id) => document.getElementById(id)?.value || '';
            const check = (id) => document.getElementById(id)?.checked ? 'Sim' : 'Não';
            const radio = (name) => {
                const checked = document.querySelector(`input[name="${name}"]:checked`);
                return checked ? checked.value : 'Não informado';
            };
            const checkboxes = (name) => {
                const checked = Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
                return checked.length > 0 ? checked.join(', ') : 'Nenhuma opção marcada';
            };

            // --- INÍCIO DA CRIAÇÃO DO CONTEÚDO DO PDF ---
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text('ANAMNESE PSICOPEDAGÓGICA', doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
            y += 15;

            const addSection = (title) => {
                y += 5;
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                linha(title.toUpperCase());
                doc.setFont("helvetica", "normal");
                doc.setFontSize(11);
                y += 2;
            };

            addSection('1. Identificação');
            linha(`Nome da Criança: ${get('nome')}`);
            linha(`Data de Nascimento: ${get('nascimento')}`);
            linha(`Idade: ${get('idade_crianca')}`);
            linha(`Endereço: ${get('endereco')}, ${get('bairro')}`);
            linha(`Instituição de Ensino: ${get('escola')}`);

            addSection('2. Dados dos Responsáveis');
            linha(`Responsável 1: ${get('resp1')} | Idade: ${get('idade1')} | Escolaridade: ${get('escolaridade1')} | Profissão: ${get('profissao1')}`);
            if (get('resp2')) {
                linha(`Responsável 2: ${get('resp2')} | Idade: ${get('idade2')} | Escolaridade: ${get('escolaridade2')} | Profissão: ${get('profissao2')}`);
            }
            linha(`Genitora: ${get('genitora')}`);
            linha(`Histórico de gestações: ${get('gestacoes')} | Partos: ${get('partos')} | Abortos: ${get('abortos')}`);
            
            addSection('3. Gestação/Nascimento');
            linha(`Gravidez planejada: ${get('planeja_pais')}`);
            linha(`Experiência da gestação: ${get('gestacao_agreavel')} - Motivo: ${get('gestacao_por_que')}`);
            linha(`Saúde da mãe na gestação: ${get('saude_mae')}`);
            linha(`Estado emocional na gestação: ${get('estado_emocional')}`);
            linha(`Fez pré-natal: ${get('fez_prenatal')} - Necessitou tratamento? ${get('tratamento_prenatal')}`);
            linha(`Tipo de parto: ${get('tipo_parto')}`);

            addSection('4. Alimentação');
            linha(`Foi amamentado: ${radio('amamentado')}`);
            linha(`Problemas com alimentação: ${get('problemas')}`);
            linha(`Alimentação atual: ${get('alimentacao')}`);

            addSection('5. Saúde');
            linha(`Vacinação atualizada: ${radio('vacina')}`);
            linha(`Doenças da infância: ${get('doencas_infancia')}`);
            let outrasSaude = checkboxes('outras');
            if (document.querySelector('input[value="Faz tratamento"]').checked) outrasSaude += ` (Tratamento: ${get('qual_tratamento')})`;
            if (document.querySelector('input[value="Medicamentos"]').checked) outrasSaude += ` (Medicamento: ${get('qual_medicamento')})`;
            linha(`Outras questões de saúde: ${outrasSaude}`);
            
            // --- FIM DA CRIAÇÃO DO CONTEÚDO DO PDF ---

            // --- INÍCIO DA LÓGICA DE ENVIO PARA O SERVIDOR ---
            try {
                // 1. Gera o PDF como um "Blob" (arquivo em memória)
                const pdfBlob = doc.output('blob');

                // 2. Cria um pacote de dados de formulário
                const formData = new FormData();
                formData.append('arquivo_pdf', pdfBlob, nomeArquivo);

                // 3. Envia o pacote para o servidor Python
                alert("Preparando para enviar anamnese. Por favor, aguarde...");

                const response = await fetch('/upload-pdf', {
                    method: 'POST',
                    body: formData
                });

                // 4. Verifica a resposta do servidor
                if (response.ok) {
                    alert("Anamnese salva com sucesso no servidor!");
                    window.location.href = '/atendimentos'; // Redireciona
                } else {
                    const erro = await response.json();
                    alert(`Erro ao salvar no servidor: ${erro.mensagem}`);
                }
            } catch (error) {
                console.error('Erro ao enviar o PDF:', error);
                alert('Ocorreu um erro de conexão ao tentar enviar a anamnese.');
            }
        }

        /**
         * Funções de interatividade da página (originais)
         */
        function toggleExpand(id) {
            const content = document.getElementById(id + 'Content');
            const title = event.currentTarget;
            if (content) {
                const isActive = title.classList.toggle('active');
                content.style.display = isActive ? 'block' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const nascimentoInput = document.getElementById('nascimento');
            const idadeInput = document.getElementById('idade_crianca');

            if (nascimentoInput) {
                nascimentoInput.addEventListener('change', () => {
                    if (nascimentoInput.value) {
                        const dataNascimento = new Date(nascimentoInput.value);
                        const hoje = new Date();
                        let idade = hoje.getFullYear() - dataNascimento.getFullYear();
                        const m = hoje.getMonth() - dataNascimento.getMonth();
                        if (m < 0 || (m === 0 && hoje.getDate() < dataNascimento.getDate())) {
                            idade--;
                        }
                        idadeInput.value = idade >= 0 ? idade : "";
                    } else {
                        idadeInput.value = "";
                    }
                });
            }
        });
    </script>
</body>
</html>
